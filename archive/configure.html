<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Configure Site Parsing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/diff-match-patch@1.0.5/index.js"></script>
  <style>
    body { background:#0d0d0d; color:#f5f5f5; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif; padding:2rem; }
    .container { max-width:840px; margin:auto; }
    .card { background:#1a1a1a; border:1px solid #2a2a2a; border-radius:1rem; padding:2rem; margin-bottom:2rem; }
    .card-header { margin-bottom:1.5rem; }
    .card-title { font-size:1.4rem; font-weight:600; color:#fff; margin:0 0 .25rem; }
    .card-description { color:#a1a1a1; font-size:.9rem; }
    .form-grid { display:grid; gap:1.25rem; }
    .form-item { display:flex; flex-direction:column; gap:.5rem; }
    .label { font-size:.7rem; letter-spacing:.05em; font-weight:600; text-transform:uppercase; color:#cfcfcf; }
    .input { background:#1e1e1e; border:1px solid #2a2a2a; border-radius:.6rem; padding:.65rem .8rem; color:#f5f5f5; font-size:.9rem; }
    .input:focus { outline:none; border-color:#3a3a3a; }
    .button { background:#1f1f1f; border:1px solid #2a2a2a; color:#f5f5f5; padding:.6rem 1.2rem; border-radius:.6rem; font-size:.8rem; font-weight:500; display:inline-flex; align-items:center; gap:.4rem; cursor:pointer; transition:background .15s,border-color .15s; }
    .button:hover:not(:disabled){ background:#252525; }
    .button:disabled { opacity:.5; cursor:not-allowed; }
    .button-success { background:#14532d; border-color:#166534; }
    .button-success:hover { background:#166534; }
    .button-danger { background:#7f1d1d; border-color:#991b1b; }
    .button-danger:hover { background:#991b1b; }
    .button-secondary { background:#262626; border-color:#333; }
    .button-secondary:hover { background:#2f2f2f; }
    .spinner { width:1rem; height:1rem; border:2px solid currentColor; border-right-color:transparent; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .alert { padding:.9rem 1rem; border-radius:.65rem; font-size:.7rem; line-height:1.1rem; margin-top:1.25rem; }
    .alert-danger { background:rgba(239,68,68,.1); border:1px solid #ef4444; color:#f87171; }
    .alert-success { background:rgba(34,197,94,.1); border:1px solid #22c55e; color:#86efac; }
    .hidden { display:none; }
    .diff-container { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem; }
    .panel { background:#111; border:1px solid #2a2a2a; padding:1rem; border-radius:.6rem; font-family:monospace; font-size:.7rem; max-height:420px; overflow:auto; line-height:1.15rem; }
    .panel::-webkit-scrollbar { width:8px; }
    .panel::-webkit-scrollbar-track { background:#1a1a1a; }
    .panel::-webkit-scrollbar-thumb { background:#333; border-radius:4px; }
    .panel::-webkit-scrollbar-thumb:hover { background:#444; }
    .ins { background:rgba(34,197,94,.15); border-left:3px solid #22c55e; padding:0 .25rem; }
    .del { background:rgba(239,68,68,.15); border-left:3px solid #ef4444; padding:0 .25rem; text-decoration:line-through; }
    .footer { text-align:center; font-size:.7rem; color:#777; margin-top:2rem; }
    .footer a { color:#bbb; text-decoration:underline; }
    .footer a:hover { color:#fff; }
  </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Generate Parser Configuration</h1>
                <p class="card-description">Provide a URL to generate the selectors for cleaning the page content.</p>
            </div>
            <form id="gen-form" class="form-grid" style="grid-template-columns: 1fr auto; align-items: flex-end;">
                <div class="form-item">
                    <label class="label" for="url">URL</label>
                    <input id="url" name="url" type="url" required placeholder="Enter Website URL" class="input" />
                </div>
                <div>
                    <button id="gen-btn" type="submit" class="button">
                        Generate
                        <div id="gen-spinner" class="spinner hidden" aria-hidden="true"></div>
                    </button>
                </div>
            </form>
            <div id="gen-alert" class="alert alert-danger hidden"></div>
        </div>

        <div id="results-section" class="card hidden">
            <h2 class="card-title">Preview Diff</h2>
            <div class="diff-container">
                <div>
                    <h3 class="label">Raw HTML</h3>
                    <div id="raw" class="panel"></div>
                </div>
                <div>
                    <h3 class="label">Cleaned Text</h3>
                    <div id="clean" class="panel"></div>
                </div>
            </div>

            <h3 class="card-title" style="margin-top: 2rem; font-size: 1.25rem;">Generated Selectors</h3>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr; margin-top: 1rem;">
                <div class="form-item">
                    <label class="label" for="include">Include</label>
                    <input id="include" class="input" />
                </div>
                <div class="form-item">
                    <label class="label" for="exclude">Exclude</label>
                    <input id="exclude" class="input" />
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button id="approve-btn" class="button button-success" type="button">Approve & Save</button>
                <button id="deny-btn" class="button button-danger" type="button">Regenerate</button>
                <button id="skip-btn" class="button button-secondary" type="button">Clear</button>
            </div>
            <div id="save-alert" class="alert alert-success hidden"></div>
        </div>

        <div class="footer">
            <a href="index.html" class="link">&larr; Back to scraper</a>
        </div>
    </div>

    <script>
        const form = document.getElementById('gen-form');
        const genBtn = document.getElementById('gen-btn');
        const genSpinner = document.getElementById('gen-spinner');
        const genAlert = document.getElementById('gen-alert');
        const results = document.getElementById('results-section');
        const rawEl = document.getElementById('raw');
        const cleanEl = document.getElementById('clean');
        const includeEl = document.getElementById('include');
        const excludeEl = document.getElementById('exclude');
        const saveAlert = document.getElementById('save-alert');

        function show(el, msg) {
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function hide(el) {
            el.classList.add('hidden');
            el.textContent = '';
        }

        // Extract only user-visible meaningful text from raw HTML
        function extractVisibleText(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                // remove unwanted elements entirely
                doc.querySelectorAll('script,style,noscript,head,meta,link,iframe,svg,canvas,nav,footer,header,aside').forEach(n=>n.remove());
                // remove comments
                const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_COMMENT, null);
                const toRemove = [];
                while (walker.nextNode()) toRemove.push(walker.currentNode);
                toRemove.forEach(n=>n.remove());
                // gather text nodes
                const blockTags = new Set(['P','DIV','SECTION','ARTICLE','MAIN','UL','OL','LI','H1','H2','H3','H4','H5','H6','TABLE','TR','TD']);
                const noisePattern = /^(home|login|log in|sign in|menu|search|skip to|toggle|copyright|all rights reserved)$/i;
                let lines = [];
                function walk(node){
                    if(node.nodeType===Node.TEXT_NODE){
                        let t = node.textContent.replace(/\s+/g,' ').trim();
                        if(t && t.length>1 && !noisePattern.test(t)) lines.push(t);
                    } else if(node.nodeType===Node.ELEMENT_NODE){
                        node.childNodes.forEach(walk);
                        if(blockTags.has(node.tagName) && lines.length && lines[lines.length-1]!== '') lines.push('');
                    }
                }
                walk(doc.body || document.createElement('div'));
                // collapse blanks
                let out = [];
                for (let i=0;i<lines.length;i++){
                    if(lines[i]==='' && (out.length===0 || out[out.length-1]==='')) continue;
                    out.push(lines[i]);
                }
                return out.join('\n').trim();
            } catch(e){
                return html;
            }
        }

        function renderDiff(rawVisible, cleaned) {
            const dmp = new diff_match_patch();
            // Line-mode diff using internal helpers
            const a = rawVisible; const b = cleaned;
            const a2 = dmp.diff_linesToChars_(a, b);
            let diffs = dmp.diff_main(a2.chars1, a2.chars2, false);
            dmp.diff_charsToLines_(diffs, a2.lineArray);
            dmp.diff_cleanupSemantic(diffs);
            function esc(s){return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]||c));}
            let leftHTML = [], rightHTML = [];
            diffs.forEach(([op, text])=>{
                const lines = text.split('\n');
                lines.forEach((ln,i)=>{
                    if(ln==='') return; // skip empty inserted separators
                    if(op===0){
                        const h = esc(ln);
                        leftHTML.push(`<div>${h}</div>`);
                        rightHTML.push(`<div>${h}</div>`);
                    } else if(op===-1){
                        leftHTML.push(`<div class="del">${esc(ln)}</div>`);
                    } else if(op===1){
                        rightHTML.push(`<div class="ins">${esc(ln)}</div>`);
                    }
                });
            });
            rawEl.innerHTML = leftHTML.join('');
            cleanEl.innerHTML = rightHTML.join('');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hide(genAlert);
            hide(saveAlert);
            results.classList.add('hidden');
            genSpinner.classList.remove('hidden');
            genBtn.disabled = true;
            try {
                const url = document.getElementById('url').value.trim();
                const resp = await fetch('http://127.0.0.1:8000/api/generate-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.detail || 'Generation failed');
                const rawVisible = extractVisibleText(data.raw_html);
                renderDiff(rawVisible, data.cleaned_text);
                includeEl.value = data.selectors.include || '';
                excludeEl.value = data.selectors.exclude || '';
                results.classList.remove('hidden');
            } catch (err) {
                show(genAlert, err.message);
            } finally {
                genSpinner.classList.add('hidden');
                genBtn.disabled = false;
            }
        });

        document.getElementById('approve-btn').addEventListener('click', async () => {
            hide(saveAlert);
            hide(genAlert);
            const url = document.getElementById('url').value.trim();
            if (!url) return;
            const domain = (new URL(url)).hostname.replace(/^www\./, '');
            const payload = {
                domain,
                include: includeEl.value.trim(),
                exclude: excludeEl.value.trim()
            };
            try {
                const resp = await fetch('http://127.0.0.1:8000/api/save-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.detail || 'Save failed');
                show(saveAlert, 'Saved successfully');
            } catch (err) {
                show(genAlert, err.message);
            }
        });

        document.getElementById('deny-btn').addEventListener('click', () => {
            form.dispatchEvent(new Event('submit'));
        });

        document.getElementById('skip-btn').addEventListener('click', () => {
            hide(results);
            hide(genAlert);
            hide(saveAlert);
            document.getElementById('url').value = '';
            includeEl.value = '';
            excludeEl.value = '';
        });
    </script>
</body>
</html>
